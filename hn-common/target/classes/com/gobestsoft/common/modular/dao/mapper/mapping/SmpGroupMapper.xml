<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gobestsoft.common.modular.dao.mapper.SmpGroupMapper">
    <resultMap id="BaseSmpGroupPojoMap" type="com.gobestsoft.common.modular.dao.model.SmpGroupPojo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 05 12:46:32 CST 2017.
        -->
        <id column="id" property="id"/>
        <result column="auid" property="auid"/>
        <result column="type" property="type"/>
        <result column="group_name" property="groupName"/>
        <result column="introduce" property="introduce"/>
        <result column="display_type" property="displayType"/>
        <result column="org_id" property="orgId"/>
        <result column="max_member" property="maxMember"/>
        <result column="head_img" property="headImg"/>
        <result column="del_flg" property="delFlg"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
    </resultMap>


    <resultMap id="groupDetailMap" type="com.gobestsoft.common.modular.smp.model.SmpGroupDetailEntity">
        <id column="id" property="id"/>
        <result column="group_name" property="name"/>
        <result column="auid" property="auid"/>
        <result column="head_img" property="cover"/>
        <result column="introduce" property="introduce"/>
        <result column="member_num" property="member_num"/>
        <result column="max_member" property="max_member"/>
        <result column="status" property="status"/>
        <result column="type" property="type"/>
        <result column="type_desc" property="type_desc"/>
        <result column="display_type" property="display_type"/>
        <result column="create_time" property="create_time"/>
        <result column="is_join" property="join_type"/>
        <result column="is_top" property="is_top"/>
        <collection property="members" select="getMembers" column="{id=id}" javaType="java.util.ArrayList"
                    ofType="com.gobestsoft.common.modular.smp.model.SmpGroupMemberEntity"/>
    </resultMap>

    <select id="groupDetail" resultMap="groupDetailMap">
         SELECT smp.id,smp.auid,smp.group_name,smp.introduce,smp.max_member,smp.head_img,smp.create_time,smp.type,smp.display_type,
         T1.name AS type_desc,smp.`status`,
        (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp.id AND auid=#{auid}) AS is_join,
        (select count(0) from smp_group_member WHERE group_id=smp.id AND auid=#{auid} and is_top =1 ) as is_top,
        (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp.id) AS member_num FROM smp_group as smp
        LEFT JOIN sys_dict AS t1 ON T1.code=smp.type  AND T1.group_code='lib_group_type'
        WHERE smp.id=#{groupId} AND smp.del_flg=0
    </select>

    <resultMap id="groupMemberMap" type="com.gobestsoft.common.modular.smp.model.SmpGroupMemberEntity">
        <id column="auid" property="auid"/>
        <result column="nick_name" property="nickname"/>
        <result column="avatar" property="avatar"/>
    </resultMap>

    <select id="getMembers" resultMap="groupMemberMap">
        SELECT T2.auid,nick_name,avatar from app_user AS T1
        INNER JOIN smp_group_member AS T2 ON  T1.auid=T2.auid  where T2.group_id=#{id}
        ORDER BY T2.create_time DESC
        LIMIT 5
    </select>

    <select id="getGroupMembers" resultMap="groupMemberMap">
        SELECT T1.auid,nick_name ,avatar from app_user AS T1
        INNER JOIN smp_group_member AS T2 ON T1.auid=T2.auid
        WHERE T2.group_id=#{groupId}
        <choose>
            <when test=" memberType == 1 ">
                AND T2.auid IN (SELECT auid FROM smp_group where id=#{groupId})
            </when>
            <when test=" memberType == 0 ">
                AND T2.auid NOT IN (SELECT auid FROM smp_group where id=#{groupId})
                AND T2.auid IN (SELECT auid FROM smp_group_member where smp_group_member.group_id=#{groupId})
            </when>
        </choose>
        ORDER BY T2.create_time DESC
    </select>

    <select id="groups" resultType="java.util.Map">
        <choose>
            <when test="searchType == 1">
                SELECT id,head_img AS cover,group_name,introduce,max_member,
                (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp_group.id) AS member_num,
                (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp_group.id AND auid=#{auid}) AS is_join
                FROM smp_group where del_flg=0 AND `status`=1
                <if test="orgId !=null and  orgId !='' ">
                    AND (display_type=0 OR (display_type=1 AND org_id=#{orgId}))
                </if>
                <if test="orgId ==null or  orgId =='' ">
                    AND display_type=0
                </if>
                ORDER BY member_num DESC
            </when>
            <when test="searchType == 2">
                SELECT T1.id,head_img AS cover,group_name,introduce,max_member,T2.is_top,
                (SELECT COUNT(0) FROM smp_group_member WHERE group_id=T1.id) AS member_num
                FROM smp_group AS T1
                INNER JOIN smp_group_member AS T2 ON T1.id=T2.group_id
                WHERE T1.del_flg=0 AND T1.`status`=1 AND T2.auid=#{auid} order by is_top DESC, T2.create_time DESC
            </when>
            <when test="searchType == 3">
                SELECT id,head_img AS cover,group_name,introduce,max_member,`status`,
                (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp_group.id) AS member_num
                FROM smp_group WHERE del_flg=0  AND auid=#{auid}
                ORDER BY create_time DESC
            </when>
            <otherwise>
                SELECT id,head_img AS cover,group_name,introduce,max_member,
                (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp_group.id) AS member_num,
                (SELECT COUNT(0) FROM smp_group_member WHERE group_id=smp_group.id AND auid=#{auid}) AS is_join
                FROM smp_group where del_flg=0 AND `status`=1
                <if test="orgId !=null and  orgId !='' ">
                    AND (display_type=0 OR (display_type=1 AND org_id=#{orgId}))
                </if>
                <if test="orgId ==null or  orgId =='' ">
                    AND display_type=0
                </if>
                ORDER BY create_time DESC
            </otherwise>
        </choose>
    </select>

    <update id="removeMember">
        DELETE  FROM smp_group_member WHERE group_id=#{groupId} and auid=#{auid}
    </update>


    <select id="groupIsTopOn" resultType="java.lang.Integer">
        SELECT COUNT(0) FROM smp_group_member WHERE group_id=#{groupId} AND auid=#{auid} AND is_top=1
    </select>

    <update id="setTopOn">
        UPDATE smp_group_member SET  is_top=1 WHERE group_id=#{groupId} AND auid=#{auid}
    </update>

    <update id="setTopOff">
        UPDATE smp_group_member SET  is_top=0 WHERE group_id=#{groupId} AND auid=#{auid}
    </update>

    <update id="joinGroup">
        INSERT smp_group_member (group_id,auid,create_time,is_top)values(#{groupId},#{auid},#{createTime},0);
    </update>

    <select id="isInGroup" resultType="java.lang.Integer">
        SELECT COUNT(0) FROM smp_group_member WHERE group_id=#{groupId} AND auid=#{auid}
    </select>

    <select id="groupsTypes" resultType="java.util.Map">
        SELECT name,code as id FROM sys_dict WHERE group_code='lib_group_type'  and code &lt;&gt; ''
    </select>

    <select id="groupMemberNumber" resultType="Integer">
        select count(0) from smp_group_member where group_id=#{groupId}
    </select>
</mapper>