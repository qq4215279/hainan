<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gobestsoft.common.modular.dao.mapper.AppIntegralMapper">
    <resultMap id="BaseResultMap" type="com.gobestsoft.common.modular.dao.model.AppIntegralPojo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 05 12:46:32 CST 2017.
        -->
        <id column="id" property="id"/>
        <result column="auid" jdbcType="VARCHAR" property="auid"/>
        <result column="type" property="type"/>
        <result column="targetId" property="targetId"/>
        <result column="value" property="value"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <resultMap id="appUserTaskMap" type="com.gobestsoft.common.modular.appuser.model.AppIntegralTaskEntity">
        <result property="task_id" column="id"/>
        <result property="task_name" column="task_name"/>
        <result property="integral" column="integral"/>
        <result property="is_complete" column="is_complete"/>
        <result property="avatar" column="avatar"/>
        <result property="complete_tip" column="complete_tip"/>
        <result property="uncomplete_tip" column="uncomplete_tip"/>
    </resultMap>


    <select id="getUserIntegralTasks" resultMap="appUserTaskMap">
        SELECT id,task_name,integral,avatar,complete_tip,uncomplete_tip,
        <choose>
            <when test="type==0">
                (SELECT COUNT(0) FROM app_integral_task_log WHERE task_id=app_integral_task.id AND auid=#{auId})
            </when>
            <when test="type==1 and startTime!=null and startTime!='' and endTime!=null and endTime!='' ">
                (SELECT COUNT(0) FROM app_integral_task_log WHERE task_id=app_integral_task.id AND auid=#{auId}
                AND complete_date &gt;=#{startTime}
                AND complete_date &lt;=#{endTime} )
            </when>
            <otherwise>
                (select 0)
            </otherwise>
        </choose>
        AS is_complete
        FROM app_integral_task WHERE type=${type}
    </select>

    <select id="getUserIntegralTasksIds" resultType="Integer">
          SELECT id FROM app_integral_task where type=${type}
    </select>


    <select id="taskIsComplete" resultType="Integer">
        SELECT COUNT(0) FROM app_integral_task_log WHERE task_id=${taskId} AND auid=#{auId}
        <if test="startTime!=null and  startTime!='' and endTime!=null and  endTime!=''">
            AND complete_date &gt;=#{startTime}
            AND complete_date &lt;=#{endTime}
        </if>
    </select>


    <select id="getTodayDailyTasksIntegral" resultType="Integer">
        SELECT COUNT(T2.integral) FROM app_integral_task_log AS T1
        INNER  JOIN app_integral_task AS T2 ON T1.task_id=T2.id
        WHERE T1.auid=#{auId}
        AND T1.complete_date &gt;=#{startTime}
        AND T1.complete_date &lt;=#{endTime}
        AND T1.task_id IN (SELECT id FROM app_integral_task where type=1)
    </select>


    <insert id="integralHouston">
		INSERT INTO app_integral(auid, create_time,type, target_id,value)
		 VALUES (#{auId}, #{createTime}, 0,${targetId}, (select integral From app_integral_task where id=${targetId}))
	</insert>

    <insert id="taskComplete">
      INSERT INTO app_integral_task_log(auid, task_id, complete_date) VALUES (#{auId}, ${taskId}, #{createTime});
    </insert>

    <resultMap type="com.gobestsoft.common.modular.appuser.model.UserIntegralEntity" id="userIntegralMap">
        <id column="id" property="id"/>
        <result column="task_name" property="name"/>
        <result column="create_time" property="create_time"/>
        <result column="value" property="value"/>
    </resultMap>

    <select id="getUserIntegralList" resultMap="userIntegralMap">
        <choose>
            <when test="type!=null and type==0">
                SELECT T1.id,T1.value,T1.create_time,T2.task_name FROM app_integral AS T1
                INNER JOIN app_integral_task AS T2 ON T1.target_id=T2.id
                WHERE T1.type=0 AND T1.auid=#{auId}
                <if test="taskId!=null">
                    AND T1.target_id=${taskId}
                </if>
                ORDER BY T1.create_time DESC
            </when>
            <when test="type!=null and type == 1">
                SELECT T1.id,T1.value,T1.create_time,'商品兑换' task_name FROM app_integral AS T1
                WHERE T1.type=1 AND T1.auid=#{auId} ORDER BY T1.create_time DESC
            </when>
            <when test="type!=null and type == 2">
                SELECT T1.id,T1.value,T1.create_time,'参加活动' task_name FROM app_integral AS T1
                WHERE T1.type=1 AND T1.auid=#{auId} ORDER BY T1.create_time DESC
            </when>
            <otherwise>
                SELECT T1.id,T1.value,T1.create_time,
                CASE WHEN T1.type=0 THEN T2.task_name
                WHEN T1.type=1 THEN '商品兑换'
                WHEN T1.type=2 THEN '参加活动' END as task_name
                FROM app_integral AS T1
                LEFT JOIN app_integral_task AS T2 ON T1.target_id=T2.id
                WHERE  T1.auid=#{auId} ORDER BY T1.create_time DESC
            </otherwise>
        </choose>
    </select>
</mapper>