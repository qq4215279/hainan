<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gobestsoft.common.modular.dao.mapper.SmpGroupPostMapper">
    <resultMap id="BaseSmpGroupPojoMap" type="com.gobestsoft.common.modular.dao.model.SmpGroupPostPojo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Dec 05 12:46:32 CST 2017.
         -->
        <id column="id" property="id"/>
        <result column="auid" property="auid"/>
        <result column="group_id" property="groupId"/>
        <result column="title" property="title"/>
        <result column="text" property="text"/>
        <result column="images" property="images"/>
        <result column="del_flg" property="delFlg"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <resultMap id="SmpGroupPostMap" type="com.gobestsoft.common.modular.smp.model.SmpGroupPostEntity">
        <id column="id" property="post_id"/>
        <result column="auid" property="auid"/>
        <result column="avatar" property="avatar"/>
        <result column="nick_name" property="nickname"/>
        <result column="title" property="title"/>
        <result column="text" property="content"/>
        <result column="images" property="images"/>
        <result column="create_time" property="create_time"/>
        <result column="comment_num" property="comment_num"/>
    </resultMap>

    <select id="getGroupPosts" resultMap="SmpGroupPostMap">
        SELECT T1.id,T1.auid,T2.nick_name,T2.avatar,T1.title,T1.text,T1.images,T1.create_time,
        (SELECT COUNT(0) FROM smp_group_comment WHERE post_id=t1.id AND smp_group_comment.del_flg=0) AS comment_num FROM smp_group_post AS T1
        INNER JOIN app_user as T2 on t1.auid=T2.auid
        WHERE T1.del_flg=0
        <if test="groupId!=null">
            AND T1.group_id=#{groupId}
        </if>
        ORDER BY T1.create_time DESC,comment_num DESC
    </select>


    <select id="postDetail" resultType="java.util.Map">
        SELECT T2.auid,T2.nick_name AS nickname,T2.avatar,T1.id,T1.create_time,T1.title,T1.text AS content,T1.images,T3.auid AS group_leader_auid,T3.id AS group_id
        FROM smp_group_post AS T1
        INNER JOIN app_user AS T2 ON t1.auid=T2.auid
         INNER JOIN smp_group AS T3 ON T3.id=T1.group_id
        WHERE T1.id=#{postId}
    </select>

    <select id="getPostReply" resultType="java.util.Map">
        SELECT T1.id,T1.text AS content,T1.create_time,T2.auid,T2.nick_name AS nickname,T2.avatar FROM smp_group_comment AS T1
        INNER JOIN app_user as T2 on t1.auid=T2.auid
        WHERE T1.post_id=#{postId} ORDER BY T1.create_time DESC
    </select>
</mapper>