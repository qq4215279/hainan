<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gobestsoft.common.modular.dao.mapper.CmsCourseMapper">
    <!--
     WARNING - @mbg.generated
     This element is automatically generated by MyBatis Generator, do not modify.
     This element was generated on 2018-02-22 17:12:35.
   -->
    <resultMap type="com.gobestsoft.common.modular.dao.model.CmsCoursePojo" id="cmsCourseMap">
        <id property="id" column="id"/>
        <result property="pid" column="pid"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="cover" column="cover"/>
        <result property="content" column="content"/>
        <result property="attachment" column="attachment"/>
        <result property="infoType" column="info_type"/>
        <result property="status" column="status"/>
        <result property="orgId" column="org_id"/>
        <result property="createUser" column="create_user"/>
        <result property="createTime" column="create_time"/>
        <result property="updateUser" column="update_user"/>
        <result property="updateTime" column="update_time"/>
        <result property="delFlg" column="del_flg"/>
    </resultMap>

    <resultMap id="CmsCourseEntityMap" type="com.gobestsoft.common.modular.cms.model.CmsCourseEntity">
        <id property="course_id" column="id"/>
        <result property="info_type" column="info_type"/>
        <result property="title" column="title"/>
        <result property="create_time" column="create_time"/>
        <result property="preview_num" column="preview_num"/>
        <result property="thumbs_up_num" column="thumbs_up_num"/>
        <result property="is_thumbs_up" column="is_thumbs_up"/>
        <result property="is_collect" column="is_collect"/>
        <result property="type" column="type"/>
        <result property="create_by" column="name"/>
    </resultMap>


    <select id="courseList" resultMap="CmsCourseEntityMap">
        SELECT id,info_type,cover,title,create_time,type,T2.name,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=3 AND course_id=T1.id) AS preview_num,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=0 AND course_id=T1.id) AS thumbs_up_num,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=0 AND course_id=T1.id AND auid=#{auid}) AS
        is_thumbs_up,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=1 AND course_id=T1.id AND auid=#{auid}) AS is_collect
        FROM cms_course AS T1
        LEFT JOIN sys_user AS T2 ON T1.create_user =T2.uid
        WHERE T1.status=1 AND T1.del_flg=0
        <choose>
            <when test="type!=null and type ==0">
                AND type=0 AND pid=0
            </when>
            <when test="type!=null and type ==1">
                AND type=1 AND pid=0
            </when>
            <when test="type!=null and type ==2">
                AND exists (select 0 from r_course_women where course_id=T1.id)
            </when>
            <otherwise>
                AND (( type=0 AND pid=0) or ( type=1 AND pid=0) or ( exists (select 0 from r_course_women where course_id=T1.id)))
            </otherwise>
        </choose>
        <if test="isCollect">
            AND EXISTS (SELECT 0 FROM cms_course_operation_log WHERE auid=#{auid} AND type =1 AND
            course_id=T1.id)
        </if>
        ORDER BY create_time DESC
    </select>

    <resultMap type="com.gobestsoft.common.modular.cms.model.ShowCmsCourseEntity" id="showCmsCourseMap">
        <id property="id" column="id"/>
        <result property="pid" column="pid"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="cover" column="cover"/>
        <result property="content" column="content"/>
        <result property="attachment" column="attachment"/>
        <result property="infoType" column="info_type"/>
        <result property="status" column="status"/>
        <result property="orgId" column="org_id"/>
        <result property="createUser" column="create_user"/>
        <result property="createTime" column="create_time"/>
        <result property="updateUser" column="update_user"/>
        <result property="updateTime" column="update_time"/>
        <result property="delFlg" column="del_flg"/>
        <result property="createUserName" column="create_username"/>
    </resultMap>

    <select id="showCmsCourse" resultMap="showCmsCourseMap">
        SELECT T1.*,T2.name AS create_username FROM cms_course AS T1 LEFT JOIN sys_user AS T2 ON T1.create_user=t2.uid
        WHERE t1.id=#{id} AND T1.del_flg=0 AND T1.status=1
    </select>

    <!-- 根据课程id,获取课程详情信息 -->
    <select id="courseDetail" resultType="map">
        SELECT id,is_share,is_like,is_collect,cover,title,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=0 AND course_id=T1.id  AND auid=#{auid}) AS has_thumbs_up,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=0 AND course_id=T1.id) AS thumbs_up_num,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=1 AND course_id=T1.id AND auid=#{auid}) AS has_collect,
        (SELECT COUNT(0)FROM cms_course_operation_log WHERE TYPE=1 AND course_id=T1.id) AS collect_num
        FROM cms_course AS T1 WHERE T1.del_flg=0 and T1.id =#{courseId}
        ORDER BY create_time DESC
    </select>
</mapper>